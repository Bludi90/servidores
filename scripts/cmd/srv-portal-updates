#!/usr/bin/env bash
set -euo pipefail

UPDATES_TXT="/srv/storage/services/portal/data/updates.txt"
TARGET_JSON="/srv/storage/services/portal/data/updates.json"

last_date="unknown"
last_text="Sin novedades registradas."
generated_at="$(date --iso-8601=seconds)"
history=()

# Para exponer los 3 últimos cambios de forma directa
recent_1=""
recent_2=""
recent_3=""

if [[ -f "$UPDATES_TXT" ]]; then
    # Leer líneas no vacías
    mapfile -t lines < <(grep -v '^[[:space:]]*$' "$UPDATES_TXT" || true)
    if ((${#lines[@]} > 0)); then
        first="${lines[0]}"
        # Formato esperado: YYYY-MM-DD texto...
        if [[ "$first" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})[[:space:]]+(.*)$ ]]; then
            last_date="${BASH_REMATCH[1]}"
            last_text="${BASH_REMATCH[2]}"
        else
            last_text="$first"
        fi
        history=("${lines[@]}")

        # Asignar últimos 3 cambios tal cual (línea completa)
        recent_1="${history[0]}"
        if ((${#history[@]} > 1)); then
            recent_2="${history[1]}"
        fi
        if ((${#history[@]} > 2)); then
            recent_3="${history[2]}"
        fi
    fi
fi

# Escapar comillas para los campos de texto simples
escape_json() {
    local s="$1"
    s="${s//\\/\\\\}"   # backslash
    s="${s//\"/\\\"}"   # comillas dobles
    echo "$s"
}

last_text_escaped="$(escape_json "$last_text")"
recent_1_escaped="$(escape_json "$recent_1")"
recent_2_escaped="$(escape_json "$recent_2")"
recent_3_escaped="$(escape_json "$recent_3")"

tmp="$(mktemp)"

{
    printf '{\n'
    printf '  "last_date": "%s",\n' "$last_date"
    printf '  "last_text": "%s",\n' "$last_text_escaped"
    printf '  "generated_at": "%s",\n' "$generated_at"
    printf '  "recent_1": "%s",\n' "$recent_1_escaped"
    printf '  "recent_2": "%s",\n' "$recent_2_escaped"
    printf '  "recent_3": "%s",\n' "$recent_3_escaped"
    printf '  "history": [\n'

    if ((${#history[@]} > 0)); then
        for ((i=0; i<${#history[@]}; i++)); do
            line="${history[$i]}"
            line_escaped="$(escape_json "$line")"
            printf '    "%s"' "$line_escaped"
            if ((i < ${#history[@]}-1)); then
                printf ',\n'
            else
                printf '\n'
            fi
        done
    fi

    printf '  ]\n'
    printf '}\n'
} > "$tmp"

mv "$tmp" "$TARGET_JSON"
chmod 644 "$TARGET_JSON"
