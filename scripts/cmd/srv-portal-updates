#!/usr/bin/env bash
set -euo pipefail

UPDATES_TXT="/srv/storage/services/portal/data/updates.txt"
TARGET_JSON="/srv/storage/services/portal/data/updates.json"

last_date="unknown"
last_text="Sin novedades registradas."
generated_at="$(date --iso-8601=seconds)"
history=()

if [[ -f "$UPDATES_TXT" ]]; then
    # Leer líneas no vacías
    mapfile -t lines < <(grep -v '^[[:space:]]*$' "$UPDATES_TXT" || true)
    if ((${#lines[@]} > 0)); then
        first="${lines[0]}"
        # Formato esperado: YYYY-MM-DD texto...
        if [[ "$first" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})[[:space:]]+(.*)$ ]]; then
            last_date="${BASH_REMATCH[1]}"
            last_text="${BASH_REMATCH[2]}"
        else
            last_text="$first"
        fi
        history=("${lines[@]}")
    fi
fi

tmp="$(mktemp)"

{
    printf '{\n'
    printf '  "last_date": "%s",\n' "$last_date"
    printf '  "last_text": "%s",\n' "$last_text"
    printf '  "generated_at": "%s",\n' "$generated_at"
    printf '  "history": [\n'

    if ((${#history[@]} > 0)); then
        for ((i=0; i<${#history[@]}; i++)); do
            line="${history[$i]}"
            # Escapar comillas
            line_escaped="${line//\"/\\\"}"
            printf '    "%s"' "$line_escaped"
            if ((i < ${#history[@]}-1)); then
                printf ',\n'
            else
                printf '\n'
            fi
        done
    fi

    printf '  ]\n'
    printf '}\n'
} > "$tmp"

mv "$tmp" "$TARGET_JSON"
chmod 644 "$TARGET_JSON"
