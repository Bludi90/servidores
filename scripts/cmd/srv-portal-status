#!/usr/bin/env bash
set -euo pipefail

# Dónde escribe el JSON que usa portal.srv
TARGET_JSON="/srv/storage/services/portal/data/status.json"

SERVER_NAME="$(hostname -s 2>/dev/null || echo 'unknown')"

# -------------------------------
# 0. Métricas básicas de sistema
# -------------------------------
load_1m="null"
mem_used_pct="null"

# Carga media a 1 minuto
if [[ -r /proc/loadavg ]]; then
    load_1m="$(awk '{print $1}' /proc/loadavg)"
fi

# RAM usada en porcentaje
if grep -q '^MemTotal:' /proc/meminfo && grep -q '^MemAvailable:' /proc/meminfo; then
    mem_total_kb=$(grep '^MemTotal:' /proc/meminfo | awk '{print $2}')
    mem_avail_kb=$(grep '^MemAvailable:' /proc/meminfo | awk '{print $2}')
    if [[ "$mem_total_kb" -gt 0 ]]; then
        mem_used_pct=$(( (mem_total_kb - mem_avail_kb) * 100 / mem_total_kb ))
    fi
fi

# --------------------------------
# 1. Estado global (srv-health)
# --------------------------------
status="UNKNOWN"

if command -v srv-health >/dev/null 2>&1; then
    if srv-health --short >/dev/null 2>&1; then
        status="OK"
    else
        status="FAIL"
    fi
fi

# --------------------------------
# 2. ZFS (pool tank)
# --------------------------------
zfs_percent="null"
zfs_health="unknown"

if command -v zpool >/dev/null 2>&1; then
    if zpool list -H -o name 2>/dev/null | grep -qx "tank"; then
        capacity="$(zpool list -H -o capacity tank 2>/dev/null || true)"
        health="$(zpool list -H -o health tank 2>/dev/null || true)"

        if [[ "$capacity" =~ ^([0-9]+)%$ ]]; then
            zfs_percent="${BASH_REMATCH[1]}"
        fi

        if [[ -n "$health" ]]; then
            zfs_health="$health"
        fi
    fi
fi

# Si ZFS no está ONLINE y por ahora todo era OK, rebajamos a WARN
if [[ "$zfs_health" != "ONLINE" && "$zfs_health" != "healthy" ]]; then
    if [[ "$status" == "OK" ]]; then
        status="WARN"
    fi
fi

# --------------------------------
# 3. Backups (log de restic)
# --------------------------------
backup_policy="Copias automáticas 3 noches por semana; conservación semanal y mensual."
last_backup="unknown"
backup_status="unknown"

log_file="/var/log/backup_restic.log"

if [[ -f "$log_file" ]]; then
    # Usamos la fecha de modificación del log como "último backup"
    ts="$(stat -c '%y' "$log_file" 2>/dev/null || true)"
    if [[ -n "$ts" ]]; then
        last_backup="$(date -d "$ts" --iso-8601=seconds 2>/dev/null || echo "$ts")"
    fi

    # Heurística simple: si hay "error" en las últimas líneas, marcamos FAIL
    if tail -n 50 "$log_file" 2>/dev/null | grep -qi "error"; then
        backup_status="FAIL"
        status="FAIL"
    else
        backup_status="OK"
    fi
fi

# --------------------------------
# 4. Tiempo (leer weather.json si existe)
# --------------------------------
weather_file="/srv/storage/services/portal/data/weather.json"

temp_now_c=""
temp_max_c=""
temp_min_c=""
rain_prob_pct=""

extract_number() {
    local key="$1" file="$2"
    sed -n 's/.*"'"$key"'":[^0-9-]*\([-0-9.][0-9.]*\).*/\1/p' "$file" | head -n1
}

if [[ -r "$weather_file" ]]; then
    temp_now_c="$(extract_number temp_now_c "$weather_file" || true)"
    temp_max_c="$(extract_number temp_max_c "$weather_file" || true)"
    temp_min_c="$(extract_number temp_min_c "$weather_file" || true)"
    rain_prob_pct="$(extract_number rain_prob_pct "$weather_file" || true)"
fi

# --------------------------------
# 5. Resumen de incidencias
# --------------------------------
issues_summary="Todo OK"

if [[ "$status" == "FAIL" ]]; then
    issues_summary="Fallo detectado. Revisar srv-health."
elif [[ "$status" == "WARN" ]]; then
    issues_summary="Advertencias en srv-health. Revisar."
fi

generated_at="$(date --iso-8601=seconds)"

# --------------------------------
# 6. Generar JSON de forma atómica
# --------------------------------
tmp="$(mktemp)"

{
    printf '{\n'
    printf '  "server_name": "%s",\n' "$SERVER_NAME"
    printf '  "status": "%s",\n' "$status"

    # ZFS
    if [[ "$zfs_percent" != "null" ]]; then
        printf '  "zfs_percent": %s,\n' "$zfs_percent"
    else
        printf '  "zfs_percent": null,\n'
    fi
    printf '  "zfs_health": "%s",\n' "$zfs_health"

    # Backups
    printf '  "last_backup": "%s",\n' "$last_backup"
    printf '  "backup_status": "%s",\n' "$backup_status"
    printf '  "backup_policy": "%s",\n' "$backup_policy"

    # Tiempo (si no hay datos, dejamos null)
    if [[ -n "$temp_now_c" ]]; then
        printf '  "temp_now_c": %s,\n' "$temp_now_c"
    else
        printf '  "temp_now_c": null,\n'
    fi

    if [[ -n "$temp_max_c" ]]; then
        printf '  "temp_max_c": %s,\n' "$temp_max_c"
    else
        printf '  "temp_max_c": null,\n'
    fi

    if [[ -n "$temp_min_c" ]]; then
        printf '  "temp_min_c": %s,\n' "$temp_min_c"
    else
        printf '  "temp_min_c": null,\n'
    fi

    if [[ -n "$rain_prob_pct" ]]; then
        printf '  "rain_prob_pct": %s,\n' "$rain_prob_pct"
    else
        printf '  "rain_prob_pct": null,\n'
    fi

    # Resumen + marca de tiempo
    printf '  "issues_summary": "%s",\n' "$issues_summary"
    printf '  "generated_at": "%s"\n' "$generated_at"
    printf '}\n'
} > "$tmp"

mv "$tmp" "$TARGET_JSON"
chmod 644 "$TARGET_JSON"
