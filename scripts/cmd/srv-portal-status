#!/usr/bin/env bash
set -euo pipefail

# D칩nde escribe el JSON que usa portal.srv
TARGET_JSON="/srv/storage/services/portal/data/status.json"

SERVER_NAME="$(hostname -s 2>/dev/null || echo 'unknown')"

# -------------------------------
# 1. Estado global via srv-health
# -------------------------------
status="UNKNOWN"
HEALTH_OUTPUT=""

if command -v srv-health >/dev/null 2>&1; then
    # Guardamos salida y usamos el c칩digo de retorno para el estado base
    if HEALTH_OUTPUT="$(srv-health 2>&1)"; then
        status="OK"
    else
        status="FAIL"
    fi
fi

# -------------------------------
# 2. ZFS (pool tank)
# -------------------------------
zfs_percent="null"
zfs_health="unknown"

if command -v zpool >/dev/null 2>&1; then
    if zpool list -H -o name 2>/dev/null | grep -qx "tank"; then
        capacity="$(zpool list -H -o capacity tank 2>/dev/null || true)"
        health="$(zpool list -H -o health tank 2>/dev/null || true)"

        if [[ "$capacity" =~ ^([0-9]+)%$ ]]; then
            zfs_percent="${BASH_REMATCH[1]}"
        fi

        if [[ -n "$health" ]]; then
            zfs_health="$health"
        fi
    fi
fi

# Si ZFS no est치 ONLINE y por ahora todo era OK, rebajamos a WARN
if [[ "$zfs_health" != "ONLINE" && "$zfs_health" != "healthy" ]]; then
    if [[ "$status" == "OK" ]]; then
        status="WARN"
    fi
fi

# -------------------------------
# 3. Backups (log de restic)
# -------------------------------
backup_policy="Copias autom치ticas 3 noches por semana; conservaci칩n semanal y mensual."
last_backup="unknown"
backup_status="unknown"

log_file="/var/log/backup_restic.log"

if [[ -f "$log_file" ]]; then
    # Usamos la fecha de modificaci칩n del log como "칰ltimo backup"
    ts="$(stat -c '%y' "$log_file" 2>/dev/null || true)"
    if [[ -n "$ts" ]]; then
        last_backup="$(date -d "$ts" --iso-8601=seconds 2>/dev/null || echo "$ts")"
    fi

    # Heur칤stica simple: si hay "error" en las 칰ltimas l칤neas, marcamos FAIL
    if tail -n 50 "$log_file" 2>/dev/null | grep -qi "error"; then
        backup_status="FAIL"
        status="FAIL"
    else
        backup_status="OK"
    fi
fi

# -------------------------------
# 4. Incidencias a partir de srv-health
# -------------------------------
issues_summary="Todo OK"

if [[ -n "$HEALTH_OUTPUT" ]]; then
    # ...
    if ((${#ISSUE_LINES[@]} > 0)); then
        # ...
        if [[ "$status" == "OK" ]]; then
            status="WARN"
        fi
    fi
fi

# Representaci칩n amigable para el portal (sem치foro con iconos)
case "$status" in
    OK)   status_display="游릭 OK" ;;
    WARN) status_display="游리 WARN" ;;
    FAIL) status_display="游댮 FAIL" ;;
    *)    status_display="$status" ;;
esac

generated_at="$(date --iso-8601=seconds)"

# -------------------------------
# 5. Generar JSON de forma at칩mica
# -------------------------------
tmp="$(mktemp)"

{
    printf '{\n'
    printf '  "server_name": "%s",\n' "$SERVER_NAME"
    printf '  "status": "%s",\n' "$status"
    printf '  "status_display": "%s",\n' "$status_display"

    if [[ "$zfs_percent" != "null" ]]; then
        printf '  "zfs_percent": %s,\n' "$zfs_percent"
    else
        printf '  "zfs_percent": null,\n'
    fi

    printf '  "zfs_health": "%s",\n' "$zfs_health"
    printf '  "last_backup": "%s",\n' "$last_backup"
    printf '  "backup_status": "%s",\n' "$backup_status"
    printf '  "backup_policy": "%s",\n' "$backup_policy"
    printf '  "issues_summary": "%s",\n' "$issues_summary"
    printf '  "generated_at": "%s"\n' "$generated_at"
    printf '}\n'
} > "$tmp"

mv "$tmp" "$TARGET_JSON"
chmod 644 "$TARGET_JSON"
