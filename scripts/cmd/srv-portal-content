#!/usr/bin/env bash
set -euo pipefail

TARGET_JSON="/srv/storage/services/portal/data/content.json"

# Rutas base (ajustá si hace falta)
JELLY_MOVIES_DIR="/srv/storage/media/N_normal/peliculas"
JELLY_SERIES_DIR="/srv/storage/media/N_normal/series"
IMMICH_LIBRARY_DIR="/srv/storage/services/immich/library"  # ↩️ ajustá según tu docker-compose

# --- helpers seguros ---

count_dirs() {
    local dir="$1"
    if [[ -d "$dir" ]]; then
        find "$dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l
    else
        echo 0
    fi
}

count_photos() {
    local dir="$1"
    if [[ -d "$dir" ]]; then
        find "$dir" -type f \
            \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \
               -iname '*.heic' -o -iname '*.heif' -o -iname '*.webp' \) \
            2>/dev/null | wc -l
    else
        echo 0
    fi
}

movies=$(count_dirs "$JELLY_MOVIES_DIR")
series=$(count_dirs "$JELLY_SERIES_DIR")
photos=$(count_photos "$IMMICH_LIBRARY_DIR")
generated_at="$(date --iso-8601=seconds)"

tmp="$(mktemp)"

{
    printf '{\n'
    printf '  "movies": %s,\n' "$movies"
    printf '  "series": %s,\n' "$series"
    printf '  "photos": %s,\n' "$photos"
    printf '  "generated_at": "%s"\n' "$generated_at"
    printf '}\n'
} >"$tmp"

mv "$tmp" "$TARGET_JSON"
chmod 644 "$TARGET_JSON"
