#!/usr/bin/env bash
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
set -Eeuo pipefail
CONF="/etc/wolctl/hosts.tsv"

die(){ echo "Error: $*  (ayuda: wolctl -h)"; exit 1; }
usage(){ cat <<'HLP'
wolctl — gestor Wake-on-LAN con /etc/wolctl/hosts.tsv
USO
  wolctl list
  wolctl show <name>
  wolctl wake <name> [name2 ...] [--iface IFACE] [--broadcast|--unicast] [--port 7|9]
  wolctl wake --all
  wolctl check <name>
  wolctl add <name> <mac> <ip> [IFACE|-]
  wolctl set <name> iface|ip|mac|user|port|notes <valor>
  wolctl rename <old> <new>
  wolctl rm <name>
  wolctl -h | --help | -help
HLP
}

ensure_conf(){ sudo install -d -m 755 /etc/wolctl; [[ -f "$CONF" ]] || echo -e "# NAME\tIF_LAN\tMAC\tIP\tWINUSER\tRUSTDESK_PORT\tNOTES" | sudo tee "$CONF" >/dev/null; }
row_by_name(){ awk -v n="$(echo "$1"|tr '[:upper:]' '[:lower:]')" 'BEGIN{FS="\t"} !/^#/ && NF && tolower($1)==n{print;exit}' "$CONF"; }
valid_mac(){ [[ "$1" =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]; }
valid_ip(){ [[ "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; }
is_iface(){ [[ -n "${1:-}" && -d "/sys/class/net/$1" ]]; }
iface_for_ip(){ ip route get "$1" 2>/dev/null | awk '{for(i=1;i<NF;i++) if($i=="dev"){print $(i+1); exit}}'; }
bcast_for(){ ip -4 addr show dev "$1" | awk '{for(i=1;i<=NF;i++) if($i=="brd"){print $(i+1); exit}}'; }

# escritura atómica
overwrite_conf_from_awk(){ local tmp; tmp="$(mktemp)"; sudo awk "$@" "$CONF" >"$tmp"; sudo install -m 644 -o root -g root "$tmp" "$CONF"; rm -f "$tmp"; }

cmd_list(){ ensure_conf; awk 'BEGIN{FS="\t"} !/^#/ && NF{print}' "$CONF" | sort -f | column -t -s $'\t' || true; }

cmd_show(){ ensure_conf; local r; r="$(row_by_name "$1")" || true; [[ -n "${r:-}" ]] || die "no existe $1"; echo -e "$r" | column -t -s $'\t'; }

send_magic(){
  local IFACE="$1" MAC="$2" MODE="$3" UDPPORT="$4"
  command -v etherwake >/dev/null || die "falta 'etherwake'"
  command -v wakeonlan >/dev/null || die "falta 'wakeonlan'"
  sudo etherwake -b -i "$IFACE" "$MAC" || true
  if [[ "$MODE" == "broadcast" ]]; then
    local BCAST; BCAST=$(bcast_for "$IFACE"); [[ -n "${BCAST:-}" ]] && wakeonlan -i "$BCAST" -p "$UDPPORT" "$MAC" || wakeonlan -p "$UDPPORT" "$MAC"
  else
    wakeonlan -p "$UDPPORT" "$MAC"
  fi
}

cmd_wake(){
  ensure_conf
  local FORCE_IFACE="" MODE="broadcast" UDPPORT="9" all=0
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --iface) FORCE_IFACE="${2:-}"; shift 2;;
      --broadcast) MODE="broadcast"; shift;;
      --unicast) MODE="unicast"; shift;;
      --port) UDPPORT="${2:-}"; shift 2;;
      --all) all=1; shift;;
      -h|--help|-help) usage; exit 0;;
      -*) die "opción no reconocida: $1";;
      *) break;;
    esac
  done
  local targets=()
  if (( all )); then mapfile -t targets < <(awk 'BEGIN{FS="\t"} !/^#/ && NF{print $1}' "$CONF")
  else (( $# >= 1 )) || die "falta <name> o --all"; targets=("$@"); fi

  for name in "${targets[@]}"; do
    local r; r="$(row_by_name "$name")" || true; [[ -n "${r:-}" ]] || { echo "Aviso: no existe $name"; continue; }
    IFS=$'\t' read -r NAME IFACE MAC IP WIN PORT NOTES <<<"$r"
    [[ -n "${FORCE_IFACE:-}" ]] && IFACE="$FORCE_IFACE"
    if ! is_iface "${IFACE:-}"; then IFACE="$(iface_for_ip "$IP" || true)"; [[ -n "$IFACE" ]] || die "no pude detectar interfaz hacia $IP"; fi
    valid_mac "$MAC" || { echo "Aviso: MAC inválida para $name"; continue; }
    echo "→ $(echo "$NAME"|tr '[:upper:]' '[:lower:]') ($MAC) via $IFACE  IP:$IP  UDP:$UDPPORT  MODE:$MODE"
    send_magic "$IFACE" "$MAC" "$MODE" "$UDPPORT"
  done
}

cmd_check(){
  command -v tcpdump >/dev/null || die "falta 'tcpdump'"
  ensure_conf
  local name="$1"; local r; r="$(row_by_name "$name")" || true; [[ -n "${r:-}" ]] || die "no existe $name"
  IFS=$'\t' read -r NAME IFACE MAC IP WIN PORT NOTES <<<"$r"
  if ! is_iface "${IFACE:-}"; then IFACE="$(iface_for_ip "$IP")"; fi
  echo "Sniffer en $IFACE y envío a $NAME ($MAC)..."
  sudo tcpdump -n -vv -i "$IFACE" 'ether proto 0x0842 or (udp and (port 7 or 9))' -c 1 &
  local S=$!; send_magic "$IFACE" "$MAC" "broadcast" "9"; wait "$S" || true
  echo "Ping a $IP"; ping -c3 "$IP" || true; arp -n "$IP" || true
}

cmd_add(){ ensure_conf
  local NAME="$1" MAC="$2" IP="$3" IFACE="${4:-}"
  valid_mac "$MAC" || die "MAC inválida"; valid_ip "$IP" || die "IP inválida"
  [[ -z "$(row_by_name "$NAME")" ]] || die "ya existe $NAME"
  echo -e "${NAME}\t${IFACE}\t${MAC}\t${IP}\t\t\t" | sudo tee -a "$CONF" >/dev/null
  echo "Añadido $NAME"
}

cmd_set(){ ensure_conf
  local NAME="$1" FIELD="$2" VAL="$3"
  [[ -n "$(row_by_name "$NAME")" ]] || die "no existe $NAME"
  local COL=0
  case "$FIELD" in
    iface) COL=2;; mac) valid_mac "$VAL"||die "MAC inválida"; COL=3;;
    ip) valid_ip "$VAL"||die "IP inválida"; COL=4;;
    user) COL=5;; port) COL=6;; notes) COL=7;;
    *) die "campo inválido (iface|ip|mac|user|port|notes)";;
  esac
  overwrite_conf_from_awk -v FS="\t" -v OFS="\t" -v n="$(echo "$NAME"|tr '[:upper:]' '[:lower:]')" -v c="$COL" -v v="$VAL" '
    /^#/ {print; next}
    tolower($1)==n {$c=v}
    {print}
  '
  echo "Actualizado $NAME: $FIELD=$VAL"
}

cmd_rename(){ ensure_conf
  local OLD="$1" NEW="$2"
  [[ -n "$(row_by_name "$OLD")" ]] || die "no existe $OLD"
  [[ -z "$(row_by_name "$NEW")" ]] || die "ya existe $NEW"
  overwrite_conf_from_awk -v FS="\t" -v OFS="\t" -v o="$(echo "$OLD"|tr '[:upper:]' '[:lower:]')" -v n="$NEW" '
    /^#/ {print; next}
    tolower($1)==o {$1=n}
    {print}
  '
  echo "Renombrado $OLD → $NEW"
}

cmd_rm(){ ensure_conf
  local NAME="$1"; [[ -n "$(row_by_name "$NAME")" ]] || die "no existe $NAME"
  overwrite_conf_from_awk -v FS="\t" -v OFS="\t" -v n="$(echo "$NAME"|tr '[:upper:]' '[:lower:]')" '
    /^#/ {print; next}
    tolower($1)==n {next}
    {print}
  '
  echo "Eliminado $NAME"
}

case "${1:-}" in
  -h|--help|-help|help) usage;;
  list)   shift; [[ $# -eq 0 ]] || die "uso: wolctl list"; cmd_list;;
  show)   shift; [[ $# -eq 1 ]] || die "uso: wolctl show <name>"; cmd_show "$1";;
  wake)   shift; [[ $# -ge 1 ]] || die "uso: wolctl wake <name...> [opciones]"; cmd_wake "$@";;
  check)  shift; [[ $# -eq 1 ]] || die "uso: wolctl check <name>"; cmd_check "$1";;
  add)    shift; [[ $# -ge 3 ]] || die "uso: wolctl add <name> <mac> <ip> [iface|-]"; cmd_add "$@";;
  set)    shift; [[ $# -eq 3 ]] || die "uso: wolctl set <name> <campo> <valor>"; cmd_set "$@";;
  rename) shift; [[ $# -eq 2 ]] || die "uso: wolctl rename <old> <new>"; cmd_rename "$@";;
  rm|del|remove) shift; [[ $# -eq 1 ]] || die "uso: wolctl rm <name>"; cmd_rm "$1";;
  *) echo "Comando no reconocido (ayuda: wolctl -h)"; exit 1;;
esac
