#!/usr/bin/env bash
set -euo pipefail
ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
H="$ROOT/scripts/help.d"

list_topics(){ [ -d "$H/wireguard" ] && echo wireguard || true; }
list_cmds(){ ls "$H"/*.help 2>/dev/null | xargs -I{} basename {} .help | sort; }
list_subcmds(){ ls "$H/$1"/*.help 2>/dev/null | xargs -I{} basename {} .help | sort; }

avail_wireguard(){
  case "${1:-}" in
    list-peers) command -v wg-list-peers >/dev/null 2>&1 && echo "Sí ($(command -v wg-list-peers))" || echo "No";;
    add-peer)   command -v wg-add-peer   >/dev/null 2>&1 && echo "Sí ($(command -v wg-add-peer))"   || echo "No";;
    del-peer)   command -v wg-del-peer   >/dev/null 2>&1 && echo "Sí ($(command -v wg-del-peer))"   || echo "No";;
    repair)     command -v wg-repair     >/dev/null 2>&1 && echo "Sí ($(command -v wg-repair))"     || echo "No";;
    *) echo ""; ;;
  esac
}

usage(){
  echo "Uso: srv-help <comando> | srv-help <tema> [subcomando]"
  echo "Temas disponibles:"; list_topics | pr -2 -t || true
  echo; echo "Comandos con ayuda:"; list_cmds | pr -2 -t || true
}

[ $# -lt 1 ] && { usage; exit 0; }

if [ "$1" = "wireguard" ]; then
  TOPIC="wireguard"; shift || true
  # Muestra índice aunque falte _index.help
  [ -r "$H/$TOPIC/_index.help" ] && cat "$H/$TOPIC/_index.help" && echo || echo "WireGuard — cheatsheet"
  echo "Subcomandos disponibles:"
  subs="$(list_subcmds "$TOPIC")"
  if [ -n "$subs" ]; then
    for s in $subs; do
      avail="$(avail_wireguard "$s")"; printf "  - %s  [Disponible: %s]\n" "$s" "${avail:-?}"
    done
  else
    echo "  (sin subcomandos documentados)"
  fi
  # ¿pidieron un subcomando?
  if [ $# -ge 1 ]; then
    SUB="$1"; FILE="$H/$TOPIC/${SUB}.help"
    echo; [ -r "$FILE" ] && { [ -n "$(avail_wireguard "$SUB")" ] && echo "[Disponible: $(avail_wireguard "$SUB")]" && echo; cat "$FILE"; } \
                        || echo "No hay ayuda para 'wireguard $SUB'"
  fi
  exit 0
fi

CMD="$1"; FILE="$H/${CMD}.help"
[ -r "$FILE" ] && { cat "$FILE"; exit 0; }
echo "No hay ayuda para '$CMD'."; echo; usage; exit 1
